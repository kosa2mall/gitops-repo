# overlays/onprem/kustomization.yaml

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base/backend
- ../../base/frontend
- secret.yaml
- harbor-secret.yaml


# 현재 테스트 중인 네임스페이스 (나중에 default로 변경 가능)
namespace: web-app

# --- backend 이미지 설정 ---

# --- frontend 이미지 설정 ---
images:
- name: 224874704033.dkr.ecr.ap-northeast-2.amazonaws.com/my-backend
  newName: harbor.ecommerce.corp/ecr-replicated/my-backend
  newTag: 107-onprem
- name: 224874704033.dkr.ecr.ap-northeast-2.amazonaws.com/my-frontend
  newName: harbor.ecommerce.corp/ecr-replicated/my-frontend
  newTag: 105-onprem

patches:
- path: tolerations-patch.yaml
- patch: |-
    - op: replace
      path: /spec/type
      value: LoadBalancer
  target:
    kind: Service
    name: backend-service
- patch: |-
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
      - name: harbor-secret
  target:
    kind: Deployment
    name: frontend-deployment
- patch: |-
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
      - name: harbor-secret
  target:
    kind: Deployment
    name: backend-deployment
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 2
  target:
    kind: Deployment
    name: frontend-deployment
- patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 2
    - op: replace
      path: /spec/maxReplicas
      value: 3
  target:
    kind: HorizontalPodAutoscaler
    name: backend-hpa

# overlays/onprem/kustomization.yaml

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base/backend
- ../../base/frontend
- secret.yaml
- harbor-secret.yaml


# 현재 테스트 중인 네임스페이스 (나중에 default로 변경 가능)
namespace: web-app

# --- backend 이미지 설정 ---

# --- frontend 이미지 설정 ---
images:
- name: 224874704033.dkr.ecr.ap-northeast-2.amazonaws.com/my-backend
  newName: harbor.ecommerce.corp/ecr-replicated/my-backend
  newTag: 90-onprem
- name: 224874704033.dkr.ecr.ap-northeast-2.amazonaws.com/my-frontend
  newName: harbor.ecommerce.corp/ecr-replicated/my-frontend
  newTag: 94-onprem

# 5. base의 설정을 덮어쓸 내용(패치)을 정의합니다.
# -----▼▼▼▼▼ 이 부분을 추가해주세요 ▼▼▼▼▼-----
# Deployment에 imagePullSecrets를 추가하는 패치

# -----▲▲▲▲▲ 여기까지 추가 ▲▲▲▲▲-----

# ----- 기존에 있던 다른 패치들 -----


patches:
- path: tolerations-patch.yaml
- patch: |-
    - op: replace
      path: /spec/type
      value: LoadBalancer
  target:
    kind: Service
    name: backend-service
- patch: |-
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
      - name: harbor-secret
  target:
    kind: Deployment
    name: frontend-deployment
- patch: |-
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
      - name: harbor-secret
  target:
    kind: Deployment
    name: backend-deployment
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 2
  target:
    kind: Deployment
    name: frontend-deployment
- patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 2
    - op: replace
      path: /spec/maxReplicas
      value: 3
  target:
    kind: HorizontalPodAutoscaler
    name: backend-hpa
